<!DOCTYPE html>
<html>
    <head>
        <title>Cheat</title>
        <meta charset="UTF-8">
        
        <style>
            #nickname-red
            {
                color: red;
            }
            
            .move-stl
            {
                color: blue;
            }
            
            #game-panel
            {
                display: none;
            }
            
            #stack
            {
                margin: 50px 0;
            }
        </style>
    </head>
    <body>
        <!--You can replace numbers by cards-->
        <div id="nickname"></div>
        <div id="list">
            <div id="listOfPlayers">

            </div>
            <a href="#" id="play">Begin game (all users connected)</a>
        </div>
        <div id="game-panel">
            <div id="stack">
                <p style="color: red;">2 heart</p>
            </div>
            <div id="players">
                
            </div>
        </div>
        <script src="/socket.io/socket.io.js"></script>
        <script src="http://code.jquery.com/jquery-3.2.1.min.js"></script>
        <script>
            $(function() {
                var socket = io();
                var nickname = "Player" + Math.floor(Math.random() * 100000).toString();
                $("#nickname").html('Playing as <span id="nickname-red">' + nickname + "</span>");
                var additionalOnStack = 0;
                var move = 0;
                var users = [];
                var cards = [];
                
                function findUser(nickname)
                {
                    var index = -1;
                    users.forEach(function(element, i) {
                        if (element.nickname === nickname) {
                            index = i;
                        }
                    });
                    
                    //debug
                    if (index < 0) {
                        throw "User not found";
                    }
                    
                    return index;
                }
                
                function passMove()
                {
                    var nick = users[move].nickname;
                    $("#" + nick).css("background-color", "#fff");
                    
                    if (++move >= users.length) {
                        move = 0;
                    }
                    
                    nick = users[move].nickname;
                    $("#" + nick).css("background-color", "#808080");
                }

                socket.emit("join game", nickname);

                socket.on("send player list", function(list) {
                    for (var i = 0; i < list.length; i++) {
                        var name = list[i];
                        
                       $("#listOfPlayers").append("<p>" + name + "</p>");
                    }
                });
                
                socket.on("user connected", function(nickname) {
                    $("#listOfPlayers").append("<p>" + nickname + "</p>");
                });
                
                socket.on("user disconnected", function(nickname) {
                    $("p:contains('" + nickname + "')").remove();
                });
                
                $("#play").click(function() {
                    socket.emit("request begin game");
                });
                
                socket.on("begin game", function(data) {
                    $("#list").fadeOut();
                    $("#game-panel").fadeIn();

                    data.numbersOfCards.forEach(function(element) {
                        users.push({ "nickname": element.nickname, "numberOfCards": element.number });
                        
                        if (element.nickname !== nickname) {
                        
                            $("#players").append('<p id="' + element.nickname + '">' + element.nickname + ": " + element.number +  "</p>");
                        } else {
                            var playerCards = $("#players").append('<p id="' + nickname + '">You: ' + element.number + '</p><div id="player-cards"></div>');
                            
                            cards = data.cards;
                            
                            cards.forEach(function(element, i) {
                                var card = playerCards.append('<img id="card' + i + '" src="/img/' + element + '.png" alt="' + element + '">');
                                //problem here
                                card.click({ "in": i }, function(event) {
                                    console.log(event.originalEvent.in);
                                });
                            });
                        }
                    });
                    
                    move = findUser(data.ownerOf2Heart);
                    passMove();
                    
                });

                socket.on("end game", function(nickname) {
                    $("body").html('<p>The game has been ended by ' + nickname + '</p><a href="#" onclick="location.reload(true);">Play again</a>');
                });
                
                socket.on("join rejected", function() {
                    $(document).write("You cannot join when game is happening");
                });
            });
        </script>
    </body>
</html>
